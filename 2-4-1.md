# レジアプリからのコールバック処理（iOS）

前回までで決済が完了し、コールバックされるまでを実装しました。今回はコールバックされた内容を読み取って結果を表示する処理を作ります。

## URLについて

コールバックされた際のURLは次のようになります。

```
https://example.com/?data=%7B%22status%22:%22ok%22,%22transaction_id%22:%2267N97N620GQ760un3ICU3yMF%22,%22client_transaction_id%22:%222F4BDFFB-2767-4B89-8EA6-A5C88237AE74%22%7D
```

まずこのクエリストリングを解析します。

具体的には location.search（クエリストリング）の有無で処理判定ができます。処理は次のように書けます。デコードしてJSONとしてパースするだけです。

```
if (location.search) {
  // コールバックされた場合
  var params = JSON.parse(
    decodeURIComponent(
      location.search.replace('?data=', '')
    ));  
}
```

その結果、次のような形になります。

```
{
  "client_transaction_id": "2F4...E74", 
  "status": "ok", 
  "transaction_id": "67N...yMF"
}
```

## パラメータの種類

このようにして取得されるデータは以下のような意味になります。

|パラメータ|内容|
|--------|--------|
|status|結果。正常終了の場合はokという文字です|
|transaction_id|トランザクションID。ユニークなIDです|
|client_transaction_id|クライアントトランザクションID。オフライン決済用です|

## JavaScriptの実装について

JavaScriptの処理は次のように書けます。 `js/app.js` の内容です。

```
if (location.search) {
  try{
    // コールバックされた場合
    var params = JSON.parse(
      decodeURIComponent(
        location.search.replace('?data=', '')
      ));  
    if (params.status == 'ok') {
      // 決済完了
      $('.alert-dialog-title').text('決済処理完了');
      $('.alert-dialog-content').text('取引IDは' + params.transaction_id + 'です');
      $('#dialog').show();
    }else{
      // 決済エラー
      $('.alert-dialog-title').text('決済処理失敗');
      $('.alert-dialog-content').text('エラーコード：' + params.error_code);
      $('#dialog').show();
    }
  } catch(e) {
    // エラーの場合
    $('.alert-dialog-title').text('決済処理失敗');
    $('.alert-dialog-content').text('データが不正です');
    $('#dialog').show();
  }
}
```

ダイアログについてはOnsen UIのものを採用しています。index.htmlの `</ons-page>` の上に次のように追加しておきます。この内容をjQueryで書き換えた上で表示しています。

```
  <!-- 決済開始するためのボタン -->
  <p>
    <ons-button modifier="large" id="square">決済する</ons-button>
  </p>

  <!-- 追記（ここから） -->
  <!-- ダイアログのテンプレート -->
  <ons-alert-dialog id="dialog">
    <div class="alert-dialog-title"></div>
    <div class="alert-dialog-content">
      
    </div>
    <div class="alert-dialog-footer">
      <button class="alert-dialog-button" onclick="hideDialog()">OK</button>
    </div>
  </ons-alert-dialog>
  <!-- 追記（ここまで） -->
</ons-page>
```

最後にダイアログを閉じるための処理を js/app.js 内に追加します。

```
var hideDialog = function() {
  $('#dialog').hide();
};
```

----

ここまでの処理でPOS APIを使ったiOSでの実装が終了となります。AndroidとiOSの判定さえ行えば両方を一つのソースに書くのは難しくありません。ぜひチャレンジしてみてください。

では続けてEコマースAPIの実装になります。[EコマースAPIについて](./3.md)をご覧ください。
