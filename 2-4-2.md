# レジアプリからのコールバック処理（iOS）

前回までで決済が完了し、コールバックされるまでを実装しました。今回はコールバックされた内容を読み取って結果を表示する処理を作ります。

## URLについて

コールバックされた際のURLは次のようになります。

```
https://example.com/?com.squareup.register.CLIENT_TRANSACTION_ID=267...bc3
```

まずこのクエリストリングを解析します。

具体的には location.search（クエリストリング）の有無で処理判定ができます。処理は次のように書けます。

```
if (location.search) {
  // コールバックされた場合
  var url = location.search.replace('?', '');
  ary = url.split('&');
  var params = {};
  for (var i = 0; i < ary.length; i++) {
    values = ary[i].split('=');
    params[values[0]] = values[1];
  }
}
```

その結果、paramsは次のような形になります。

```
{
  "com.squareup.register.CLIENT_TRANSACTION_ID": "3b0...4de", 
  "com.squareup.register.SERVER_TRANSACTION_ID": "c6O...vMF"
}
```

## パラメータの種類

このようにして取得されるデータは以下のような意味になります。

|パラメータ|内容|
|--------|--------|
|com.squareup.pos.SERVER_TRANSACTION_ID|トランザクションID。ユニークなIDです|
|com.squareup.pos.CLIENT_TRANSACTION_ID|クライアントトランザクションID。決済によってはクライアント側だけで管理されますので、そのIDです|


## JavaScriptの実装について

JavaScriptの処理は次のように書けます。 `js/app.js` の内容です。

```
if (location.search) {
  try{
    // コールバックされた場合
    var url = location.search.replace('?', '');
    ary = url.split('&');
    var params = {};
    for (var i = 0; i < ary.length; i++) {
      values = ary[i].split('=');
      params[values[0]] = values[1];
    }
    if (params['com.squareup.pos.CLIENT_TRANSACTION_ID']) {
      // 決済完了
      $('.alert-dialog-title').text('決済処理完了');
      $('.alert-dialog-content').text('取引IDは' + params['com.squareup.pos.CLIENT_TRANSACTION_ID'] + 'です');
      $('#dialog').show();
    }else{
      // 決済エラー
      $('.alert-dialog-title').text('決済処理失敗');
      $('.alert-dialog-content').text('エラーコード：' + params['com.squareup.pos.ERROR_DESCRIPTION']);
      $('#dialog').show();
    }
  } catch(e) {
    // エラーの場合
    $('.alert-dialog-title').text('決済処理失敗');
    $('.alert-dialog-content').text('データが不正です');
    $('#dialog').show();
  }
}
```

ダイアログについてはOnsen UIのものを採用しています。index.htmlの `</ons-page>` の上に次のように追加しておきます。この内容をjQueryで書き換えた上で表示しています。

```
  <!-- 決済開始するためのボタン -->
  <p>
    <ons-button modifier="large" id="square">決済する</ons-button>
  </p>

  <!-- 追記（ここから） -->
  <!-- ダイアログのテンプレート -->
  <ons-alert-dialog id="dialog">
    <div class="alert-dialog-title"></div>
    <div class="alert-dialog-content">
      
    </div>
    <div class="alert-dialog-footer">
      <button class="alert-dialog-button" onclick="hideDialog()">OK</button>
    </div>
  </ons-alert-dialog>
  <!-- 追記（ここまで） -->
</ons-page>
```

最後にダイアログを閉じるための処理を js/app.js 内に追加します。

```
var hideDialog = function() {
  $('#dialog').hide();
};
```

----

ここまでの処理でPOS APIを使ったiOSでの実装が終了となります。AndroidとiOSの判定さえ行えば両方を一つのソースに書くのは難しくありません。ぜひチャレンジしてみてください。

では続けてEコマースAPIの実装になります。[EコマースAPIについて](./3.md)をご覧ください。
