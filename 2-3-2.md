# レジアプリの呼び出し（Android）

ではレジアプリを呼び出す部分を作ります。これはJavaScriptで実装しますので、`</body>` の上でファイルを読み込むようにします。

```
  <script src="vendors/onsenui/js/onsenui.min.js"></script>
  <script src="vendors/jquery/dist/jquery.min.js"></script>
  <!-- 追加 -->
  <script src="js/app.js"></script>
</body>
```

では作っていきます。

## 全体像

まずはコメントで全体像を紹介します。この内容は `public/js/app.js` になります。

```
// 定数の定義

// Onsen UIが使える状態になったところから処理開始
ons.ready(function() {
  // ボタンを押した時のイベント処理
    // 変数の取得
    
    // パラメータの生成
    
    // URLの生成
    
    // POSレジアプリ呼び出し
});
```

## 定数の定義

今回利用する定数は次の通りです。

```
var url = ''; // コールバックするURL
var client_id = ''; // SquareのアプリケーションID
```

まずコールバックされるURLはHeokuにデプロイされたURLになります。例えば `https://calm-lake-99428.herokuapp.com/` です。client_idはSquare Developer Portalで確認できるApplication IDになります。

![](images/2-3-1-1.png)

**POSレジアプリは本番環境のアプリケーションIDでしか動きませんので注意してください。サンドボックスのものは使えません。**

さらにこのコールバックURLはSquare Developer Portalの **Point of Sale API > Web > Web Callback URLs** にも指定します。

![](images/2-3-1-2.png)

## ボタンを押した時のイベント処理

ボタンを押した時の処理はjQueryで行います。

```
// ボタンを押した時のイベント処理
$('#square').on('click', function(e) {
  // 変数の取得
  
  // パラメータの生成
  
  // URLの生成
  
  // POSレジアプリ呼び出し
});
```

## 変数の取得

今回の変数は次の通りです。

- 決済額
- 決済内容
- 提供する決済方法

### 決済額

決済額は次のように得られます。

```
var price = $('#price').val();
```

### 決済内容

決済内容は次のように得られます。

```
var notes = $('#notes').val();
```

### 提供する決済方法

決済方法はチェックされているものだけを取得するので若干複雑になります。

```
var supported_tender_types = $("input[name='supported_tender_types[]']:checked").map(function() {
  return $(this).val();
}).toArray();
```

## パラメータの説明

変数を取得した結果、POSレジアプリに送るパラメータは次のようになります。

```
var dataParameter = {
  // インテントのアクション。 com.squareup.pos.action.CHARGE 固定です。
  "action": "com.squareup.pos.action.CHARGE",
  // POSレジアプリがコールバックするURL
  "S.com.squareup.pos.WEB_CALLBACK_URI": url,
  // アプリケーションID（自分のものに置き換えてください）
  "S.com.squareup.pos.CLIENT_ID": client_id,
  // バージョン（現在は1.3固定です）
  "S.com.squareup.pos.API_VERSION": 'v1.3',
  // 金額に関する情報
  "i.com.squareup.pos.TOTAL_AMOUNT": price,
  "S.com.squareup.pos.CURRENCY_CODE": "JPY",
  // 利用できる決済方法
  "S.com.squareup.pos.TENDER_TYPES": supported_tender_types.join(","),
  // パッケージ。必ず com.squareup を指定
  "package": "com.squareup",
  // 取引に関する説明書き
  "S.com.squareup.pos.NOTE": notes
};
```

## URLの生成

生成したパラメータを元にURLを作ります。各パラメータを;繋ぎで渡すのが特徴です。また、最後に ;end と付けるのを忘れないでください。

```
// URLの生成
params = [];
for (var key in dataParameter) {
  params.push(`${key}=${dataParameter[key]}`);
}
var uri = "intent:#Intent;" + params.join(';') + ';end';
```

## POSレジアプリ呼び出し

そしてURLに適用すればPOSレジアプリが呼び出されます。

```
location.href = uri;
```

## JavaScript全体のコード

その結果、全体のコードは次のようになります。

```
// 定数の定義
var url = ''; // コールバックするURL
var client_id = ''; // SquareのアプリケーションID

// Onsen UIが使える状態になったところから処理開始
ons.ready(function() {
  // ボタンを押した時のイベント処理
  $('#square').on('click', function(e) {
    // 変数の取得
    var price = $('#price').val();
    var notes = $('#notes').val();
    var supported_tender_types = $("input[name='supported_tender_types[]']:checked").map(function() {
      return $(this).val();
    }).toArray();

    // パラメータの生成
    var dataParameter = {
      // インテントのアクション。 com.squareup.pos.action.CHARGE 固定です。
      "action": "com.squareup.pos.action.CHARGE",
      // POSレジアプリがコールバックするURL
      "S.com.squareup.pos.WEB_CALLBACK_URI": url,
      // アプリケーションID（自分のものに置き換えてください）
      "S.com.squareup.pos.CLIENT_ID": client_id,
      // バージョン（現在は1.3固定です）
      "S.com.squareup.pos.API_VERSION": 'v1.3',
      // 金額に関する情報
      "i.com.squareup.pos.TOTAL_AMOUNT": price,
      "S.com.squareup.pos.CURRENCY_CODE": "JPY",
      // 利用できる決済方法
      "S.com.squareup.pos.TENDER_TYPES": supported_tender_types.join(","),
      // パッケージ。必ず com.squareup を指定
      "package": "com.squareup",
      // 取引に関する説明書き
      "S.com.squareup.pos.NOTE": notes
    };
    
    // URLの生成
    params = [];
    for (var key in dataParameter) {
      params.push(`${key}=${dataParameter[key]}`);
    }
    var uri = "intent:#Intent;" + params.join(';') + ';end';
    
    // POSレジアプリ呼び出し
    location.href = uri;
  });
});
```

## 試す

ではこのコードをGitリポジトリにコミットし、Herokuにデプロイします。

```
$ git add .
$ git commit -m "Add JavaScript"
$ git push heroku master
```

そして、そのデプロイ先のURLにAndroidからアクセスします。

金額、内容、提供する決済方法を選択します。テストの際には必ず現金を有効にしておくのをお勧めします。

この時、あらかじめSquareリーダーを差し込んでおくことでICチップなどを使った決済ができます。

決済が無事終了するとコールバックされて最初の画面が表示されます。

----

次回はPOS APIの最後の回になります。コールバックされた内容を読み取り、画面に表示します。
